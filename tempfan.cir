* RTS Fan Control - Temperature to PWM Simulation
* LM35 Sensor (0-100°C) -> STM32F103C8 ADC -> 2N2222 Motor Driver

.title RTS Fan Control Simulation

* ============================================================
* VOLTAGE SOURCES
* ============================================================
VCC 1 0 DC 5V          ; 5V Supply for motor
VDD 2 0 DC 3.3V       ; 3.3V Supply for STM32
VTEMP 3 0 DC 0V       ; Temperature input (0V = 0°C)

* ============================================================
* LM35 TEMPERATURE SENSOR MODEL
* Output: 10mV per °C (0.5V @ 50°C, 1.0V @ 100°C)
* ============================================================
* Temperature sweep: linearly increase from 0°C to 100°C
* Simulates 0V (0°C) to 1.0V (100°C)
RTEMP_SRC 3 4 10k
ETEMP 4 0 5 0 0.01    ; E_out = 0.01 * V_src = 10mV/°C
CTEMP 4 0 100n

* ============================================================
* STM32F103C8 BEHAVIORAL MODEL
* Simplified: ADC input voltage -> PWM output voltage
* Scaling: 0-3.3V input -> 0-5V PWM output
* ============================================================
EADC 5 0 4 0 1.515    ; ADC gain (5V / 3.3V ≈ 1.515)
RADC 5 6 10k          ; ADC input impedance
CADC 6 0 1u           ; Input filter

* Temperature threshold logic:
* IF V_temp < 0.3V (< 30°C): PWM = 0V (motor off)
* IF V_temp >= 0.3V (>= 30°C): PWM proportional to temp
* ============================================================
ETHRESH 7 0 VALUE = {IF(V(4) < 0.3, 0, V(4) * 1.515)}
CPWM 7 8 10u          ; PWM output smoothing
RPWM 8 0 1Meg

* ============================================================
* 2N2222 TRANSISTOR DRIVER + MOTOR LOAD
* Motor model: Resistance + Inductance + Back-EMF
* ============================================================

* Base resistor (STM32 PA6 -> 2N2222 base)
RBASE 8 9 1k

* 2N2222 NPN Transistor
Q1 1 9 10 Q2N2222
RE1 10 0 100

* Motor Load (Equivalent circuit)
RMOTOR 1 11 100       ; Motor winding resistance
LMOTOR 11 12 10m      ; Motor inductance
CMOTOR 12 0 100u      ; Output smoothing

* Freewheeling Diode (1N4007)
D1 12 1 D1N4007

* ============================================================
* COMPONENT MODELS
* ============================================================

* 2N2222 NPN Transistor (Typical small-signal transistor)
.model Q2N2222 NPN (
+ IS=14.34E-15
+ BF=255.9
+ NF=1.307
+ VAF=74.03
+ IKF=0.2847
+ ISE=14.34E-15
+ NE=1.307
+ BR=6.092
+ NR=1
+ VAR=24
+ IKR=0
+ ISC=0
+ NC=2
+ RB=10
+ IRB=0.1
+ RBM=10
+ RE=0
+ RC=1
+ CJE=26.08E-12
+ VJE=0.75
+ MJE=0.377
+ TF=411E-12
+ XTF=3
+ VTF=1.7
+ ITF=0.6
+ PTF=0
+ CJC=7.306E-12
+ VJEC=0.75
+ MNJC=0.3085
+ XCJC=1
+ TR=46.91E-9
+ XTB=1.5
+ EG=1.11
+ XTI=3
+ FC=0.5
)

* 1N4007 Diode (General purpose rectifier)
.model D1N4007 D (
+ IS=5.84E-14
+ RS=0.8
+ N=1.906
+ BV=1000
+ IBV=100E-6
+ CJO=1.0E-11
+ VJ=0.75
+ M=0.333
+ FC=0.5
+ TT=4.761E-9
)

* ============================================================
* TRANSIENT ANALYSIS
* ============================================================

* Temperature sweep: 0 to 100°C over 10 seconds
* Rate: 10°C per second
.control
    alter VTEMP DC 0    ; Start at 0V (0°C)
    tran 0.01 10 0 0.01 ; Simulate 10 seconds with 0.01s steps
    
    * Manually increase temperature source over time
    * At each time point, calculate temperature
    alter VTEMP DC 0.1
    
    * Output results to file
    set wr_singlescale
    set wr_vecnames
    option numdgt=6
    wrdata output.csv v(4) v(8) v(12)
    
.endc

.end
