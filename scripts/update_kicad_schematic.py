#!/usr/bin/env python3
"""
Update KiCad schematic with electrical improvements:
- Reverse LM35 pins (pin 1 to +3.3V, pin 3 to GND)
- Add STM32 power connections (VDD to +3.3V, VSS to GND)
- Add NRST with 10kΩ pull-up resistor
- Add BOOT0 tied to GND
- Power LM35 from +3.3V (not 5V)
- Add +5V_MOTOR supply label with 100µF decoupling cap
- Add 0.1µF and 10µF decoupling caps for STM32
- Verify flyback diode cathode to +5V_MOTOR
- Add UART header (RX/TX/GND)
"""

import os

def generate_improved_schematic():
    schematic_content = """(kicad_sch (version 20230121) (generator eeschema)

  (uuid 9a8d4c80-fac4-4cbb-90c3-17fbb4451be3)

  (paper "A4")

  (title_block
    (title "STM32F103C8 Fan Control System")
    (date "2025-11-07")
    (rev "2.0")
    (company "Real-Time Systems Project")
    (comment 1 "Temperature-controlled DC fan using PWM")
    (comment 2 "LM35 sensor - Proper power connections")
    (comment 3 "UART debug output on PA9/PA10")
    (comment 4 "Decoupling capacitors and proper reset circuit")
  )

  (lib_symbols
    (symbol "MCU_ST_STM32F1:STM32F103C8Tx" (in_bom yes) (on_board yes)
      (property "Reference" "U1" (at 0 2.54 0)
        (effects (font (size 1.27 1.27)))
      )
      (property "Value" "STM32F103C8T6" (at 0 0 0)
        (effects (font (size 1.27 1.27)))
      )
      (property "Footprint" "Package_QFP:LQFP-48_7x7mm_P0.5mm" (at 0 -2.54 0)
        (effects (font (size 1.27 1.27)) hide)
      )
      (symbol "STM32F103C8Tx_0_1"
        (rectangle (start -15.24 40.64) (end 15.24 -40.64)
          (stroke (width 0.254) (type default))
          (fill (type background))
        )
      )
      (symbol "STM32F103C8Tx_1_1"
        (pin power_in line (at -2.54 43.18 270) (length 2.54)
          (name "VDD" (effects (font (size 1.27 1.27))))
          (number "1" (effects (font (size 1.27 1.27))))
        )
        (pin power_in line (at -2.54 -43.18 90) (length 2.54)
          (name "VSS" (effects (font (size 1.27 1.27))))
          (number "2" (effects (font (size 1.27 1.27))))
        )
        (pin input line (at 17.78 15.24 180) (length 2.54)
          (name "NRST" (effects (font (size 1.27 1.27))))
          (number "7" (effects (font (size 1.27 1.27))))
        )
        (pin bidirectional line (at -17.78 10.16 0) (length 2.54)
          (name "PA0-ADC" (effects (font (size 1.27 1.27))))
          (number "10" (effects (font (size 1.27 1.27))))
        )
        (pin bidirectional line (at -17.78 2.54 0) (length 2.54)
          (name "PA6-PWM" (effects (font (size 1.27 1.27))))
          (number "16" (effects (font (size 1.27 1.27))))
        )
        (pin bidirectional line (at -17.78 -2.54 0) (length 2.54)
          (name "PA9-TX" (effects (font (size 1.27 1.27))))
          (number "30" (effects (font (size 1.27 1.27))))
        )
        (pin bidirectional line (at -17.78 -5.08 0) (length 2.54)
          (name "PA10-RX" (effects (font (size 1.27 1.27))))
          (number "31" (effects (font (size 1.27 1.27))))
        )
        (pin input line (at 17.78 -15.24 180) (length 2.54)
          (name "BOOT0" (effects (font (size 1.27 1.27))))
          (number "44" (effects (font (size 1.27 1.27))))
        )
      )
    )
    
    (symbol "Sensor_Temperature:LM35" (in_bom yes) (on_board yes)
      (property "Reference" "U2" (at 0 5.08 0)
        (effects (font (size 1.27 1.27)))
      )
      (property "Value" "LM35" (at 0 2.54 0)
        (effects (font (size 1.27 1.27)))
      )
      (property "Footprint" "Package_TO_SOT_THT:TO-92_Inline" (at 0 -2.54 0)
        (effects (font (size 1.27 1.27)) hide)
      )
      (symbol "LM35_0_1"
        (rectangle (start -5.08 1.27) (end 5.08 -7.62)
          (stroke (width 0.254) (type default))
          (fill (type background))
        )
      )
      (symbol "LM35_1_1"
        (pin power_in line (at 0 3.81 270) (length 2.54)
          (name "VCC" (effects (font (size 1.27 1.27))))
          (number "1" (effects (font (size 1.27 1.27))))
        )
        (pin output line (at 7.62 -2.54 180) (length 2.54)
          (name "OUT" (effects (font (size 1.27 1.27))))
          (number "2" (effects (font (size 1.27 1.27))))
        )
        (pin power_in line (at 0 -10.16 90) (length 2.54)
          (name "GND" (effects (font (size 1.27 1.27))))
          (number "3" (effects (font (size 1.27 1.27))))
        )
      )
    )
    
    (symbol "Transistor_BJT:2N2222" (pin_names (offset 0) hide) (in_bom yes) (on_board yes)
      (property "Reference" "Q1" (at 5.08 1.905 0)
        (effects (font (size 1.27 1.27)) (justify left))
      )
      (property "Value" "2N2222" (at 5.08 0 0)
        (effects (font (size 1.27 1.27)) (justify left))
      )
      (symbol "2N2222_0_1"
        (polyline
          (pts
            (xy 0.635 0.635)
            (xy 2.54 2.54)
          )
          (stroke (width 0) (type default))
          (fill (type none))
        )
        (polyline
          (pts
            (xy 0.635 -0.635)
            (xy 2.54 -2.54)
            (xy 2.54 -2.54)
          )
          (stroke (width 0) (type default))
          (fill (type none))
        )
        (polyline
          (pts
            (xy 0.635 1.905)
            (xy 0.635 -1.905)
            (xy 0.635 -1.905)
          )
          (stroke (width 0.508) (type default))
          (fill (type none))
        )
        (polyline
          (pts
            (xy 1.27 -1.778)
            (xy 1.778 -1.27)
            (xy 2.286 -2.286)
            (xy 1.27 -1.778)
            (xy 1.27 -1.778)
          )
          (stroke (width 0) (type default))
          (fill (type outline))
        )
        (circle (center 1.27 0) (radius 2.8194)
          (stroke (width 0.254) (type default))
          (fill (type none))
        )
      )
      (symbol "2N2222_1_1"
        (pin passive line (at 2.54 -5.08 90) (length 2.54)
          (name "E" (effects (font (size 1.27 1.27))))
          (number "1" (effects (font (size 1.27 1.27))))
        )
        (pin input line (at -5.08 0 0) (length 5.715)
          (name "B" (effects (font (size 1.27 1.27))))
          (number "2" (effects (font (size 1.27 1.27))))
        )
        (pin passive line (at 2.54 5.08 270) (length 2.54)
          (name "C" (effects (font (size 1.27 1.27))))
          (number "3" (effects (font (size 1.27 1.27))))
        )
      )
    )
    
    (symbol "Device:R" (pin_numbers hide) (pin_names (offset 0)) (in_bom yes) (on_board yes)
      (property "Reference" "R" (at 2.032 0 90)
        (effects (font (size 1.27 1.27)))
      )
      (property "Value" "R" (at 0 0 90)
        (effects (font (size 1.27 1.27)))
      )
      (symbol "R_0_1"
        (rectangle (start -1.016 -2.54) (end 1.016 2.54)
          (stroke (width 0.254) (type default))
          (fill (type none))
        )
      )
      (symbol "R_1_1"
        (pin passive line (at 0 3.81 270) (length 1.27)
          (name "~" (effects (font (size 1.27 1.27))))
          (number "1" (effects (font (size 1.27 1.27))))
        )
        (pin passive line (at 0 -3.81 90) (length 1.27)
          (name "~" (effects (font (size 1.27 1.27))))
          (number "2" (effects (font (size 1.27 1.27))))
        )
      )
    )
    
    (symbol "Device:C" (pin_numbers hide) (pin_names (offset 0.254)) (in_bom yes) (on_board yes)
      (property "Reference" "C" (at 0.635 2.54 0)
        (effects (font (size 1.27 1.27)) (justify left))
      )
      (property "Value" "C" (at 0.635 -2.54 0)
        (effects (font (size 1.27 1.27)) (justify left))
      )
      (symbol "C_0_1"
        (polyline
          (pts
            (xy -2.032 -0.762)
            (xy 2.032 -0.762)
          )
          (stroke (width 0.508) (type default))
          (fill (type none))
        )
        (polyline
          (pts
            (xy -2.032 0.762)
            (xy 2.032 0.762)
          )
          (stroke (width 0.508) (type default))
          (fill (type none))
        )
      )
      (symbol "C_1_1"
        (pin passive line (at 0 3.81 270) (length 2.794)
          (name "~" (effects (font (size 1.27 1.27))))
          (number "1" (effects (font (size 1.27 1.27))))
        )
        (pin passive line (at 0 -3.81 90) (length 2.794)
          (name "~" (effects (font (size 1.27 1.27))))
          (number "2" (effects (font (size 1.27 1.27))))
        )
      )
    )
    
    (symbol "Diode:1N4007" (pin_numbers hide) (pin_names (offset 1.016) hide) (in_bom yes) (on_board yes)
      (property "Reference" "D" (at 0 2.54 0)
        (effects (font (size 1.27 1.27)))
      )
      (property "Value" "1N4007" (at 0 -2.54 0)
        (effects (font (size 1.27 1.27)))
      )
      (symbol "1N4007_0_1"
        (polyline
          (pts
            (xy -1.27 1.27)
            (xy -1.27 -1.27)
          )
          (stroke (width 0.254) (type default))
          (fill (type none))
        )
        (polyline
          (pts
            (xy 1.27 0)
            (xy -1.27 0)
          )
          (stroke (width 0) (type default))
          (fill (type none))
        )
        (polyline
          (pts
            (xy 1.27 1.27)
            (xy 1.27 -1.27)
            (xy -1.27 0)
            (xy 1.27 1.27)
          )
          (stroke (width 0.254) (type default))
          (fill (type none))
        )
      )
      (symbol "1N4007_1_1"
        (pin passive line (at -3.81 0 0) (length 2.54)
          (name "K" (effects (font (size 1.27 1.27))))
          (number "1" (effects (font (size 1.27 1.27))))
        )
        (pin passive line (at 3.81 0 180) (length 2.54)
          (name "A" (effects (font (size 1.27 1.27))))
          (number "2" (effects (font (size 1.27 1.27))))
        )
      )
    )
    
    (symbol "Motor:Motor_DC" (pin_names (offset 0)) (in_bom yes) (on_board yes)
      (property "Reference" "M1" (at 2.54 3.81 0)
        (effects (font (size 1.27 1.27)) (justify left))
      )
      (property "Value" "DC_Fan" (at 2.54 1.905 0)
        (effects (font (size 1.27 1.27)) (justify left))
      )
      (symbol "Motor_DC_0_1"
        (circle (center 0 0) (radius 3.2512)
          (stroke (width 0.254) (type default))
          (fill (type none))
        )
        (polyline
          (pts
            (xy 0 -5.08)
            (xy 0 -3.2)
          )
          (stroke (width 0) (type default))
          (fill (type none))
        )
        (polyline
          (pts
            (xy 0 5.08)
            (xy 0 3.2)
          )
          (stroke (width 0) (type default))
          (fill (type none))
        )
      )
      (symbol "Motor_DC_1_1"
        (pin passive line (at 0 7.62 270) (length 2.54)
          (name "+" (effects (font (size 1.27 1.27))))
          (number "1" (effects (font (size 1.27 1.27))))
        )
        (pin passive line (at 0 -7.62 90) (length 2.54)
          (name "-" (effects (font (size 1.27 1.27))))
          (number "2" (effects (font (size 1.27 1.27))))
        )
      )
    )
    
    (symbol "Connector:Conn_01x03_Pin" (pin_names (offset 1.016) hide) (in_bom yes) (on_board yes)
      (property "Reference" "J" (at 0 5.08 0)
        (effects (font (size 1.27 1.27)))
      )
      (property "Value" "UART" (at 0 -5.08 0)
        (effects (font (size 1.27 1.27)))
      )
      (symbol "Conn_01x03_Pin_1_1"
        (polyline
          (pts
            (xy 1.27 -2.54)
            (xy 0.8636 -2.54)
          )
          (stroke (width 0.1524) (type default))
          (fill (type none))
        )
        (polyline
          (pts
            (xy 1.27 0)
            (xy 0.8636 0)
          )
          (stroke (width 0.1524) (type default))
          (fill (type none))
        )
        (polyline
          (pts
            (xy 1.27 2.54)
            (xy 0.8636 2.54)
          )
          (stroke (width 0.1524) (type default))
          (fill (type none))
        )
        (rectangle (start 0.8636 -2.413) (end 0 -2.667)
          (stroke (width 0.1524) (type default))
          (fill (type outline))
        )
        (rectangle (start 0.8636 0.127) (end 0 -0.127)
          (stroke (width 0.1524) (type default))
          (fill (type outline))
        )
        (rectangle (start 0.8636 2.667) (end 0 2.413)
          (stroke (width 0.1524) (type default))
          (fill (type outline))
        )
        (pin passive line (at 5.08 2.54 180) (length 3.81)
          (name "Pin_1" (effects (font (size 1.27 1.27))))
          (number "1" (effects (font (size 1.27 1.27))))
        )
        (pin passive line (at 5.08 0 180) (length 3.81)
          (name "Pin_2" (effects (font (size 1.27 1.27))))
          (number "2" (effects (font (size 1.27 1.27))))
        )
        (pin passive line (at 5.08 -2.54 180) (length 3.81)
          (name "Pin_3" (effects (font (size 1.27 1.27))))
          (number "3" (effects (font (size 1.27 1.27))))
        )
      )
    )
    
    (symbol "power:+3.3V" (power) (pin_names (offset 0)) (in_bom yes) (on_board yes)
      (property "Reference" "#PWR" (at 0 -3.81 0)
        (effects (font (size 1.27 1.27)) hide)
      )
      (property "Value" "+3.3V" (at 0 3.556 0)
        (effects (font (size 1.27 1.27)))
      )
      (symbol "+3.3V_0_1"
        (polyline
          (pts
            (xy -0.762 1.27)
            (xy 0 2.54)
          )
          (stroke (width 0) (type default))
          (fill (type none))
        )
        (polyline
          (pts
            (xy 0 0)
            (xy 0 2.54)
          )
          (stroke (width 0) (type default))
          (fill (type none))
        )
        (polyline
          (pts
            (xy 0 2.54)
            (xy 0.762 1.27)
          )
          (stroke (width 0) (type default))
          (fill (type none))
        )
      )
      (symbol "+3.3V_1_1"
        (pin power_in line (at 0 0 90) (length 0) hide
          (name "+3.3V" (effects (font (size 1.27 1.27))))
          (number "1" (effects (font (size 1.27 1.27))))
        )
      )
    )
    
    (symbol "power:+5V_MOTOR" (power) (pin_names (offset 0)) (in_bom yes) (on_board yes)
      (property "Reference" "#PWR" (at 0 -3.81 0)
        (effects (font (size 1.27 1.27)) hide)
      )
      (property "Value" "+5V_MOTOR" (at 0 3.556 0)
        (effects (font (size 1.27 1.27)))
      )
      (symbol "+5V_MOTOR_0_1"
        (polyline
          (pts
            (xy -0.762 1.27)
            (xy 0 2.54)
          )
          (stroke (width 0) (type default))
          (fill (type none))
        )
        (polyline
          (pts
            (xy 0 0)
            (xy 0 2.54)
          )
          (stroke (width 0) (type default))
          (fill (type none))
        )
        (polyline
          (pts
            (xy 0 2.54)
            (xy 0.762 1.27)
          )
          (stroke (width 0) (type default))
          (fill (type none))
        )
      )
      (symbol "+5V_MOTOR_1_1"
        (pin power_in line (at 0 0 90) (length 0) hide
          (name "+5V_MOTOR" (effects (font (size 1.27 1.27))))
          (number "1" (effects (font (size 1.27 1.27))))
        )
      )
    )
    
    (symbol "power:GND" (power) (pin_names (offset 0)) (in_bom yes) (on_board yes)
      (property "Reference" "#PWR" (at 0 -6.35 0)
        (effects (font (size 1.27 1.27)) hide)
      )
      (property "Value" "GND" (at 0 -3.81 0)
        (effects (font (size 1.27 1.27)))
      )
      (symbol "GND_0_1"
        (polyline
          (pts
            (xy 0 0)
            (xy 0 -1.27)
            (xy 1.27 -1.27)
            (xy 0 -2.54)
            (xy -1.27 -1.27)
            (xy 0 -1.27)
          )
          (stroke (width 0) (type default))
          (fill (type none))
        )
      )
      (symbol "GND_1_1"
        (pin power_in line (at 0 0 270) (length 0) hide
          (name "GND" (effects (font (size 1.27 1.27))))
          (number "1" (effects (font (size 1.27 1.27))))
        )
      )
    )
  )

  (junction (at 50.8 40.64) (diameter 0) (color 0 0 0 0)
    (uuid 9e01234a-5678-9012-3456-789012345678)
  )
  (junction (at 88.9 30.48) (diameter 0) (color 0 0 0 0)
    (uuid 8e01234a-5678-9012-3456-789012345678)
  )
  (junction (at 88.9 116.84) (diameter 0) (color 0 0 0 0)
    (uuid 7e01234a-5678-9012-3456-789012345678)
  )
  (junction (at 127 76.2) (diameter 0) (color 0 0 0 0)
    (uuid bfc0d01d-8787-45a7-baa1-ec4a97eed377)
  )
  (junction (at 165.1 55.88) (diameter 0) (color 0 0 0 0)
    (uuid e86708b7-3ab6-4e54-bb21-edaf4bc11401)
  )
  (junction (at 210.82 71.12) (diameter 0) (color 0 0 0 0)
    (uuid 1e01234a-5678-9012-3456-789012345678)
  )
  (junction (at 165.1 116.84) (diameter 0) (color 0 0 0 0)
    (uuid 2e01234a-5678-9012-3456-789012345678)
  )

  (wire (pts (xy 50.8 40.64) (xy 50.8 77.47))
    (stroke (width 0) (type default))
    (uuid wire-lm35-vcc-1)
  )
  
  (wire (pts (xy 58.42 81.28) (xy 62.23 81.28))
    (stroke (width 0) (type default))
    (uuid wire-lm35-out-1)
  )
  (wire (pts (xy 62.23 81.28) (xy 62.23 83.82))
    (stroke (width 0) (type default))
    (uuid wire-lm35-out-2)
  )
  (wire (pts (xy 62.23 83.82) (xy 71.12 83.82))
    (stroke (width 0) (type default))
    (uuid wire-lm35-out-3)
  )
  
  ; LM35 pin 3 (GND) to GND
  (wire (pts (xy 50.8 91.44) (xy 50.8 116.84))
    (stroke (width 0) (type default))
    (uuid wire-lm35-gnd-1)
  )
  (wire (pts (xy 50.8 116.84) (xy 88.9 116.84))
    (stroke (width 0) (type default))
    (uuid wire-lm35-gnd-2)
  )
  
  ; STM32 VDD to +3.3V
  (wire (pts (xy 86.36 30.48) (xy 88.9 30.48))
    (stroke (width 0) (type default))
    (uuid wire-stm32-vdd-1)
  )
  (wire (pts (xy 88.9 30.48) (xy 91.44 30.48))
    (stroke (width 0) (type default))
    (uuid wire-stm32-vdd-2)
  )
  
  ; STM32 VSS to GND
  (wire (pts (xy 86.36 116.84) (xy 88.9 116.84))
    (stroke (width 0) (type default))
    (uuid wire-stm32-vss-1)
  )
  (wire (pts (xy 88.9 116.84) (xy 165.1 116.84))
    (stroke (width 0) (type default))
    (uuid wire-stm32-vss-2)
  )
  
  ; NRST pull-up to +3.3V
  (wire (pts (xy 106.68 58.42) (xy 111.76 58.42))
    (stroke (width 0) (type default))
    (uuid wire-nrst-1)
  )
  (wire (pts (xy 111.76 58.42) (xy 111.76 48.26))
    (stroke (width 0) (type default))
    (uuid wire-nrst-2)
  )
  (wire (pts (xy 111.76 48.26) (xy 119.38 48.26))
    (stroke (width 0) (type default))
    (uuid wire-nrst-3)
  )
  (wire (pts (xy 119.38 48.26) (xy 119.38 40.64))
    (stroke (width 0) (type default))
    (uuid wire-nrst-4)
  )
  
  ; BOOT0 to GND
  (wire (pts (xy 106.68 88.9) (xy 111.76 88.9))
    (stroke (width 0) (type default))
    (uuid wire-boot0-1)
  )
  (wire (pts (xy 111.76 88.9) (xy 111.76 116.84))
    (stroke (width 0) (type default))
    (uuid wire-boot0-2)
  )
  
  ; PA0 (ADC) from LM35
  ; (already connected above)
  
  ; PA6 (PWM) to base resistor
  (wire (pts (xy 104.14 76.2) (xy 111.76 76.2))
    (stroke (width 0) (type default))
    (uuid wire-pa6-1)
  )
  (wire (pts (xy 111.76 76.2) (xy 119.38 76.2))
    (stroke (width 0) (type default))
    (uuid wire-pa6-2)
  )
  
  ; Base resistor to transistor
  (wire (pts (xy 127 76.2) (xy 134.62 76.2))
    (stroke (width 0) (type default))
    (uuid wire-base-1)
  )
  (wire (pts (xy 134.62 76.2) (xy 134.62 83.82))
    (stroke (width 0) (type default))
    (uuid wire-base-2)
  )
  
  ; Transistor collector to motor
  (wire (pts (xy 139.7 83.82) (xy 139.7 71.12))
    (stroke (width 0) (type default))
    (uuid wire-collector-1)
  )
  (wire (pts (xy 139.7 71.12) (xy 165.1 71.12))
    (stroke (width 0) (type default))
    (uuid wire-collector-2)
  )
  
  ; Motor positive to +5V_MOTOR
  (wire (pts (xy 165.1 63.5) (xy 165.1 55.88))
    (stroke (width 0) (type default))
    (uuid wire-motor-pos-1)
  )
  (wire (pts (xy 165.1 55.88) (xy 210.82 55.88))
    (stroke (width 0) (type default))
    (uuid wire-motor-pos-2)
  )
  
  ; Flyback diode cathode to +5V_MOTOR
  (wire (pts (xy 165.1 55.88) (xy 165.1 76.2))
    (stroke (width 0) (type default))
    (uuid wire-diode-cathode-1)
  )
  
  ; Flyback diode anode to motor negative
  (wire (pts (xy 165.1 85.09) (xy 165.1 78.74))
    (stroke (width 0) (type default))
    (uuid wire-diode-anode-1)
  )
  (wire (pts (xy 165.1 85.09) (xy 165.1 88.9))
    (stroke (width 0) (type default))
    (uuid wire-diode-anode-2)
  )
  
  ; Motor negative to transistor emitter
  (wire (pts (xy 139.7 91.44) (xy 139.7 116.84))
    (stroke (width 0) (type default))
    (uuid wire-emitter-1)
  )
  (wire (pts (xy 139.7 116.84) (xy 165.1 116.84))
    (stroke (width 0) (type default))
    (uuid wire-emitter-2)
  )
  (wire (pts (xy 165.1 88.9) (xy 165.1 116.84))
    (stroke (width 0) (type default))
    (uuid wire-motor-neg-1)
  )
  
  ; +5V_MOTOR decoupling cap to GND
  (wire (pts (xy 210.82 63.5) (xy 210.82 71.12))
    (stroke (width 0) (type default))
    (uuid wire-motor-cap-1)
  )
  (wire (pts (xy 210.82 78.74) (xy 210.82 116.84))
    (stroke (width 0) (type default))
    (uuid wire-motor-cap-2)
  )
  
  ; STM32 decoupling caps
  (wire (pts (xy 99.06 30.48) (xy 99.06 38.1))
    (stroke (width 0) (type default))
    (uuid wire-dec-cap1-1)
  )
  (wire (pts (xy 99.06 45.72) (xy 99.06 116.84))
    (stroke (width 0) (type default))
    (uuid wire-dec-cap1-2)
  )
  (wire (pts (xy 106.68 30.48) (xy 106.68 38.1))
    (stroke (width 0) (type default))
    (uuid wire-dec-cap2-1)
  )
  (wire (pts (xy 106.68 45.72) (xy 106.68 116.84))
    (stroke (width 0) (type default))
    (uuid wire-dec-cap2-2)
  )
  
  ; +3.3V rail
  (wire (pts (xy 50.8 40.64) (xy 88.9 40.64))
    (stroke (width 0) (type default))
    (uuid wire-3v3-rail-1)
  )
  (wire (pts (xy 88.9 30.48) (xy 88.9 40.64))
    (stroke (width 0) (type default))
    (uuid wire-3v3-rail-2)
  )
  (wire (pts (xy 88.9 40.64) (xy 99.06 40.64))
    (stroke (width 0) (type default))
    (uuid wire-3v3-rail-3)
  )
  (wire (pts (xy 99.06 40.64) (xy 99.06 30.48))
    (stroke (width 0) (type default))
    (uuid wire-3v3-rail-4)
  )
  (wire (pts (xy 99.06 40.64) (xy 106.68 40.64))
    (stroke (width 0) (type default))
    (uuid wire-3v3-rail-5)
  )
  (wire (pts (xy 106.68 40.64) (xy 106.68 30.48))
    (stroke (width 0) (type default))
    (uuid wire-3v3-rail-6)
  )
  (wire (pts (xy 106.68 40.64) (xy 119.38 40.64))
    (stroke (width 0) (type default))
    (uuid wire-3v3-rail-7)
  )
  
  ; UART header connections
  (wire (pts (xy 104.14 68.58) (xy 185.42 68.58))
    (stroke (width 0) (type default))
    (uuid wire-uart-tx)
  )
  (wire (pts (xy 104.14 71.12) (xy 185.42 71.12))
    (stroke (width 0) (type default))
    (uuid wire-uart-rx)
  )
  (wire (pts (xy 165.1 116.84) (xy 185.42 116.84))
    (stroke (width 0) (type default))
    (uuid wire-uart-gnd-1)
  )
  (wire (pts (xy 185.42 73.66) (xy 185.42 116.84))
    (stroke (width 0) (type default))
    (uuid wire-uart-gnd-2)
  )
  
  ; +5V_MOTOR to motor supply
  (wire (pts (xy 210.82 55.88) (xy 210.82 63.5))
    (stroke (width 0) (type default))
    (uuid wire-5v-motor-supply)
  )

  (text "Temperature Sensor\\n(Software Simulated)" (at 25.4 68.58 0)
    (effects (font (size 1.27 1.27)) (justify left bottom))
    (uuid text-lm35)
  )
  (text "STM32 Controller\\n72MHz ARM Cortex-M3" (at 71.12 20.32 0)
    (effects (font (size 1.27 1.27)) (justify left bottom))
    (uuid text-stm32)
  )
  (text "Fan Driver Circuit\\nPWM @ 8kHz" (at 142.24 45.72 0)
    (effects (font (size 1.27 1.27)) (justify left bottom))
    (uuid text-driver)
  )
  (text "Power Supplies:\\n+3.3V: STM32 & LM35\\n+5V_MOTOR: Fan supply" 
    (at 200.66 30.48 0)
    (effects (font (size 1.016 1.016)) (justify left bottom))
    (uuid text-power)
  )
  (text "PA0: ADC Input (Temperature)\\nPA6: PWM Output (TIM3_CH1)\\nPA9/PA10: UART Debug @ 115200" 
    (at 45.72 127 0)
    (effects (font (size 1.016 1.016)) (justify left bottom))
    (uuid text-pins)
  )

  ; Component instances
  (symbol (lib_id "Sensor_Temperature:LM35") (at 50.8 81.28 0) (mirror y) (unit 1)
    (in_bom yes) (on_board yes) (dnp no)
    (uuid lm35-instance)
    (property "Reference" "U2" (at 44.45 73.66 0)
      (effects (font (size 1.27 1.27)) (justify left))
    )
    (property "Value" "LM35" (at 44.45 76.2 0)
      (effects (font (size 1.27 1.27)) (justify left))
    )
    (property "Footprint" "Package_TO_SOT_THT:TO-92_Inline" (at 50.8 83.82 0)
      (effects (font (size 1.27 1.27)) hide)
    )
    (pin "1" (uuid lm35-pin1))
    (pin "2" (uuid lm35-pin2))
    (pin "3" (uuid lm35-pin3))
  )

  (symbol (lib_id "MCU_ST_STM32F1:STM32F103C8Tx") (at 88.9 73.66 0) (unit 1)
    (in_bom yes) (on_board yes) (dnp no)
    (uuid stm32-instance)
    (property "Reference" "U1" (at 88.9 20.32 0)
      (effects (font (size 1.27 1.27)))
    )
    (property "Value" "STM32F103C8T6" (at 88.9 22.86 0)
      (effects (font (size 1.27 1.27)))
    )
    (property "Footprint" "Package_QFP:LQFP-48_7x7mm_P0.5mm" (at 88.9 116.84 0)
      (effects (font (size 1.27 1.27)) hide)
    )
    (pin "1" (uuid stm32-pin1))
    (pin "2" (uuid stm32-pin2))
    (pin "7" (uuid stm32-pin7))
    (pin "10" (uuid stm32-pin10))
    (pin "16" (uuid stm32-pin16))
    (pin "30" (uuid stm32-pin30))
    (pin "31" (uuid stm32-pin31))
    (pin "44" (uuid stm32-pin44))
  )

  (symbol (lib_id "Device:R") (at 123.19 76.2 90) (unit 1)
    (in_bom yes) (on_board yes) (dnp no)
    (uuid r1-base)
    (property "Reference" "R1" (at 123.19 71.12 90)
      (effects (font (size 1.27 1.27)))
    )
    (property "Value" "1k" (at 123.19 73.66 90)
      (effects (font (size 1.27 1.27)))
    )
    (property "Footprint" "Resistor_THT:R_Axial_DIN0207_L6.3mm_D2.5mm_P10.16mm_Horizontal" (at 123.19 77.978 0)
      (effects (font (size 1.27 1.27)) hide)
    )
    (pin "1" (uuid r1-pin1))
    (pin "2" (uuid r1-pin2))
  )

  (symbol (lib_id "Device:R") (at 119.38 44.45 0) (unit 1)
    (in_bom yes) (on_board yes) (dnp no)
    (uuid r2-nrst)
    (property "Reference" "R2" (at 121.92 43.18 0)
      (effects (font (size 1.27 1.27)) (justify left))
    )
    (property "Value" "10k" (at 121.92 45.72 0)
      (effects (font (size 1.27 1.27)) (justify left))
    )
    (property "Footprint" "Resistor_THT:R_Axial_DIN0207_L6.3mm_D2.5mm_P10.16mm_Horizontal" (at 117.602 44.45 90)
      (effects (font (size 1.27 1.27)) hide)
    )
    (pin "1" (uuid r2-pin1))
    (pin "2" (uuid r2-pin2))
  )

  (symbol (lib_id "Transistor_BJT:2N2222") (at 137.16 83.82 0) (unit 1)
    (in_bom yes) (on_board yes) (dnp no)
    (uuid q1-driver)
    (property "Reference" "Q1" (at 142.24 80.01 0)
      (effects (font (size 1.27 1.27)) (justify left))
    )
    (property "Value" "2N2222" (at 142.24 82.55 0)
      (effects (font (size 1.27 1.27)) (justify left))
    )
    (property "Footprint" "Package_TO_SOT_THT:TO-92_Inline" (at 142.24 85.725 0)
      (effects (font (size 1.27 1.27) italic) (justify left) hide)
    )
    (pin "1" (uuid q1-pin1))
    (pin "2" (uuid q1-pin2))
    (pin "3" (uuid q1-pin3))
  )

  (symbol (lib_id "Diode:1N4007") (at 165.1 81.28 270) (unit 1)
    (in_bom yes) (on_board yes) (dnp no)
    (uuid d1-flyback)
    (property "Reference" "D1" (at 167.64 80.01 90)
      (effects (font (size 1.27 1.27)) (justify left))
    )
    (property "Value" "1N4007" (at 167.64 82.55 90)
      (effects (font (size 1.27 1.27)) (justify left))
    )
    (property "Footprint" "Diode_THT:D_DO-41_SOD81_P10.16mm_Horizontal" (at 160.655 81.28 0)
      (effects (font (size 1.27 1.27)) hide)
    )
    (pin "1" (uuid d1-pin1))
    (pin "2" (uuid d1-pin2))
  )

  (symbol (lib_id "Motor:Motor_DC") (at 165.1 71.12 0) (unit 1)
    (in_bom yes) (on_board yes) (dnp no)
    (uuid m1-fan)
    (property "Reference" "M1" (at 170.18 67.31 0)
      (effects (font (size 1.27 1.27)) (justify left))
    )
    (property "Value" "DC_Fan" (at 170.18 69.85 0)
      (effects (font (size 1.27 1.27)) (justify left))
    )
    (property "Footprint" "" (at 165.1 73.406 0)
      (effects (font (size 1.27 1.27)) hide)
    )
    (pin "1" (uuid m1-pin1))
    (pin "2" (uuid m1-pin2))
  )

  (symbol (lib_id "Device:C") (at 99.06 41.91 0) (unit 1)
    (in_bom yes) (on_board yes) (dnp no)
    (uuid c1-dec)
    (property "Reference" "C1" (at 100.33 39.37 0)
      (effects (font (size 1.27 1.27)) (justify left))
    )
    (property "Value" "0.1µF" (at 100.33 44.45 0)
      (effects (font (size 1.27 1.27)) (justify left))
    )
    (property "Footprint" "Capacitor_THT:C_Disc_D5.0mm_W2.5mm_P5.00mm" (at 99.9948 45.72 0)
      (effects (font (size 1.27 1.27)) hide)
    )
    (pin "1" (uuid c1-pin1))
    (pin "2" (uuid c1-pin2))
  )

  (symbol (lib_id "Device:C") (at 106.68 41.91 0) (unit 1)
    (in_bom yes) (on_board yes) (dnp no)
    (uuid c2-dec)
    (property "Reference" "C2" (at 107.95 39.37 0)
      (effects (font (size 1.27 1.27)) (justify left))
    )
    (property "Value" "10µF" (at 107.95 44.45 0)
      (effects (font (size 1.27 1.27)) (justify left))
    )
    (property "Footprint" "Capacitor_THT:CP_Radial_D5.0mm_P2.50mm" (at 107.6148 45.72 0)
      (effects (font (size 1.27 1.27)) hide)
    )
    (pin "1" (uuid c2-pin1))
    (pin "2" (uuid c2-pin2))
  )

  (symbol (lib_id "Device:C") (at 210.82 67.31 0) (unit 1)
    (in_bom yes) (on_board yes) (dnp no)
    (uuid c3-motor)
    (property "Reference" "C3" (at 212.09 64.77 0)
      (effects (font (size 1.27 1.27)) (justify left))
    )
    (property "Value" "100µF" (at 212.09 69.85 0)
      (effects (font (size 1.27 1.27)) (justify left))
    )
    (property "Footprint" "Capacitor_THT:CP_Radial_D6.3mm_P2.50mm" (at 211.7548 71.12 0)
      (effects (font (size 1.27 1.27)) hide)
    )
    (pin "1" (uuid c3-pin1))
    (pin "2" (uuid c3-pin2))
  )

  (symbol (lib_id "Connector:Conn_01x03_Pin") (at 180.34 71.12 0) (mirror x) (unit 1)
    (in_bom yes) (on_board yes) (dnp no)
    (uuid j1-uart)
    (property "Reference" "J1" (at 180.34 76.2 0)
      (effects (font (size 1.27 1.27)))
    )
    (property "Value" "UART" (at 180.34 78.74 0)
      (effects (font (size 1.27 1.27)))
    )
    (property "Footprint" "Connector_PinHeader_2.54mm:PinHeader_1x03_P2.54mm_Vertical" (at 180.34 71.12 0)
      (effects (font (size 1.27 1.27)) hide)
    )
    (pin "1" (uuid j1-pin1))
    (pin "2" (uuid j1-pin2))
    (pin "3" (uuid j1-pin3))
  )

  (symbol (lib_id "power:+3.3V") (at 50.8 40.64 0) (unit 1)
    (in_bom yes) (on_board yes) (dnp no)
    (uuid pwr-3v3)
    (property "Reference" "#PWR01" (at 50.8 44.45 0)
      (effects (font (size 1.27 1.27)) hide)
    )
    (property "Value" "+3.3V" (at 50.8 36.83 0)
      (effects (font (size 1.27 1.27)))
    )
    (pin "1" (uuid pwr-3v3-pin1))
  )

  (symbol (lib_id "power:+5V_MOTOR") (at 210.82 55.88 0) (unit 1)
    (in_bom yes) (on_board yes) (dnp no)
    (uuid pwr-5v-motor)
    (property "Reference" "#PWR02" (at 210.82 59.69 0)
      (effects (font (size 1.27 1.27)) hide)
    )
    (property "Value" "+5V_MOTOR" (at 210.82 52.07 0)
      (effects (font (size 1.27 1.27)))
    )
    (pin "1" (uuid pwr-5v-motor-pin1))
  )

  (symbol (lib_id "power:GND") (at 88.9 116.84 0) (unit 1)
    (in_bom yes) (on_board yes) (dnp no)
    (uuid pwr-gnd)
    (property "Reference" "#PWR03" (at 88.9 123.19 0)
      (effects (font (size 1.27 1.27)) hide)
    )
    (property "Value" "GND" (at 88.9 120.65 0)
      (effects (font (size 1.27 1.27)))
    )
    (pin "1" (uuid pwr-gnd-pin1))
  )

  (sheet_instances
    (path "/" (page "1"))
  )
)
"""
    
    return schematic_content

def main():
    print("=" * 80)
    print("KiCad Schematic Update - Electrical Improvements")
    print("=" * 80)
    print("\nGenerating improved schematic with:")
    print("  ✓ LM35 pins reversed (pin 1 to +3.3V, pin 3 to GND)")
    print("  ✓ STM32 power connections (VDD to +3.3V, VSS to GND)")
    print("  ✓ NRST with 10kΩ pull-up resistor to +3.3V")
    print("  ✓ BOOT0 tied to GND")
    print("  ✓ LM35 powered from +3.3V (safe for PA0)")
    print("  ✓ +5V_MOTOR supply label with 100µF decoupling cap")
    print("  ✓ 0.1µF and 10µF decoupling caps for STM32")
    print("  ✓ Flyback diode cathode to +5V_MOTOR")
    print("  ✓ UART header (TX/RX/GND)")
    print()
    
    # Get the circuit directory path
    script_dir = os.path.dirname(os.path.abspath(__file__))
    project_dir = os.path.dirname(script_dir)
    circuit_dir = os.path.join(project_dir, "circuit")
    output_file = os.path.join(circuit_dir, "RTS_FanControl.kicad_sch")
    
    # Generate the schematic
    schematic_content = generate_improved_schematic()
    
    # Write to file
    with open(output_file, 'w', encoding='utf-8') as f:
        f.write(schematic_content)
    
    print(f"✓ Updated schematic saved to: {output_file}")
    print()
    print("Open the schematic in KiCad to view the improvements!")
    print("=" * 80)

if __name__ == "__main__":
    main()
